<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby Balance</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Living Background --- */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -50;
            background: linear-gradient(135deg, #eef2f3 0%, #e0e7ec 100%);
            overflow: hidden;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.5;
            animation: float 25s infinite alternate ease-in-out;
        }

        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: rgba(255, 255, 255, 0.8); animation-duration: 25s; }
        .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: rgba(220, 225, 230, 0.6); animation-duration: 30s; animation-direction: alternate-reverse; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: rgba(255, 255, 255, 0.6); animation-duration: 35s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, -30px) scale(1.05); }
        }

        /* --- Glassmorphism --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #334155;
            transition: all 0.2s ease;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.5);
            outline: none;
            border-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            color: #475569;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.55);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            color: #1e293b;
        }
        .glass-btn:active { transform: translateY(0); background: rgba(255, 255, 255, 0.7); }
        .glass-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .glass-bad-active {
            background: rgba(254, 226, 226, 0.3);
            border-color: rgba(254, 202, 202, 0.4);
        }

        /* --- Helpers --- */
        .hidden-force { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Remove arrows from number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-700">

    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Login Modal (Overlay) -->
    <div id="modal-login" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-200/50 backdrop-blur-md transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-sm mx-6 p-8 shadow-2xl">
            <div class="text-center mb-6">
                <div class="inline-block p-3 rounded-full bg-white/40 mb-3">
                    <i data-lucide="user-circle" class="w-8 h-8 text-slate-500"></i>
                </div>
                <h2 class="text-2xl font-medium text-slate-800">Who is this?</h2>
                <p class="text-sm text-slate-500 mt-1">Please enter your name</p>
            </div>

            <div class="space-y-4">
                <input type="text" id="login-name" placeholder="Name (e.g. Elijah, Lacey)" class="glass-input w-full rounded-xl px-4 py-3 text-lg text-center placeholder-slate-400 capitalize" oninput="checkLoginName()">
                
                <div id="pin-container" class="hidden-force space-y-2 overflow-hidden transition-all duration-300">
                    <p class="text-xs text-center text-slate-400 font-bold uppercase tracking-wide">Enter PIN</p>
                    <input type="password" id="login-pin" maxlength="4" class="glass-input w-full rounded-xl px-4 py-3 text-lg text-center tracking-[0.5em]" placeholder="••••">
                </div>

                <button onclick="attemptLogin()" class="w-full py-3 glass-btn rounded-xl font-medium text-slate-800 mt-2">
                    Enter
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 glass-panel border-b-0 border-b border-white/40 mb-6">
        <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="baby" class="w-6 h-6 text-slate-600"></i>
                <div>
                    <h1 class="text-xl font-semibold tracking-tight text-slate-700 leading-none">Baby Balance</h1>
                    <span id="current-user-badge" class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Guest</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="logout()" class="glass-btn p-2 rounded-full" title="Logout">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
                <button onclick="openSettings()" id="btn-settings" class="glass-btn p-2 rounded-full hidden-force">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-4xl mx-auto w-full px-6 space-y-8 pb-10">

        <!-- Stats / Overview -->
        <div class="grid grid-cols-2 gap-4">
            <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in" style="animation-delay: 0.05s;">
                <span class="text-slate-500 text-[10px] font-semibold uppercase tracking-widest mb-2">Total Balance</span>
                <span class="text-4xl font-light text-slate-800" id="total-balance">--</span>
                <span class="text-xs text-slate-400 mt-1">Baby Bucks</span>
            </div>
            <div id="card-store-manager" class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer transition-transform hover:scale-[1.02] fade-in hidden-force" style="animation-delay: 0.1s;" onclick="openStoreManager()">
                <span class="text-slate-500 text-[10px] font-semibold uppercase tracking-widest mb-2">Store Items</span>
                <span class="text-4xl font-light text-slate-800" id="total-items">--</span>
                <span class="text-xs text-slate-400 mt-1">Manage Inventory</span>
            </div>
            <!-- Replacement for Store Manager card for non-admins -->
            <div id="card-store-readonly" class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in hidden-force" style="animation-delay: 0.1s;">
                 <span class="text-slate-500 text-[10px] font-semibold uppercase tracking-widest mb-2">Store Items</span>
                <span class="text-4xl font-light text-slate-800" id="total-items-ro">--</span>
                <span class="text-xs text-slate-400 mt-1">Available</span>
            </div>
        </div>

        <!-- Children Section -->
        <div class="fade-in" style="animation-delay: 0.15s;">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-medium text-slate-600">Siblings</h2>
                <button id="btn-add-child" onclick="openAddChildModal()" class="glass-btn px-4 py-2 rounded-xl text-sm font-medium flex items-center gap-2 hidden-force">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add
                </button>
            </div>
            
            <div id="children-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Children cards generated here -->
                <div class="col-span-full py-16 text-center text-slate-400 glass-panel rounded-2xl">
                    <p class="text-sm font-light">Loading family data...</p>
                </div>
            </div>
        </div>

        <!-- Store Preview Section -->
        <div class="fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-lg font-medium text-slate-600 mb-5">Item Store</h2>
            <div id="store-preview-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <!-- Store items generated here -->
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-auto py-8">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-xs font-light tracking-wide">Baby Balance &copy; Local Storage</p>
        </div>
    </footer>

    <!-- MODALS -->
    
    <!-- Add Child Modal -->
    <div id="modal-add-child" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-md mx-6 p-8 shadow-2xl transform scale-95 transition-all duration-300">
            <h3 class="text-xl font-medium text-slate-800 mb-6">Add New Child</h3>
            <input type="text" id="new-child-name" placeholder="Child's Name" class="glass-input w-full rounded-xl px-4 py-3 mb-6 text-lg placeholder-slate-400">
            <div class="flex gap-4">
                <button onclick="closeModal('modal-add-child')" class="flex-1 py-3 glass-btn rounded-xl font-medium">Cancel</button>
                <button onclick="addChild()" class="flex-1 py-3 glass-btn rounded-xl font-medium text-slate-800 bg-white/40">Save</button>
            </div>
        </div>
    </div>

    <!-- Bad Behavior Modal -->
    <div id="modal-bad" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-md mx-6 p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="mx-auto w-12 h-12 flex items-center justify-center mb-2">
                    <i data-lucide="frown" class="w-8 h-8 text-slate-400"></i>
                </div>
                <h3 class="text-xl font-medium text-slate-800">Log Action</h3>
                <p class="text-sm text-slate-500 font-light mt-1">Pauses earning for a duration.</p>
            </div>
            
            <input type="hidden" id="bad-child-id">
            
            <div class="grid grid-cols-3 gap-3 mb-8">
                <button onclick="setBadTime(15)" class="time-btn glass-btn rounded-xl py-3 text-sm font-medium">15m</button>
                <button onclick="setBadTime(30)" class="time-btn glass-btn rounded-xl py-3 text-sm font-medium">30m</button>
                <button onclick="setBadTime(60)" class="time-btn glass-btn rounded-xl py-3 text-sm font-medium">1h</button>
            </div>
            
            <div class="flex gap-4">
                <button onclick="closeModal('modal-bad')" class="flex-1 py-3 glass-btn rounded-xl font-medium">Cancel</button>
                <button onclick="confirmBadAction()" class="flex-1 py-3 glass-btn rounded-xl font-medium text-red-500 hover:text-red-600">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="modal-shop" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-lg mx-6 p-0 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-white/30 flex justify-between items-center bg-white/40">
                <div>
                    <h3 class="text-lg font-medium text-slate-800">Spend</h3>
                    <p class="text-xs text-slate-500 font-light mt-1">For <span id="shop-child-name" class="font-medium text-slate-700">...</span></p>
                </div>
                <button onclick="closeModal('modal-shop')" class="glass-btn p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <!-- Discount Section -->
            <div class="px-6 py-3 bg-slate-50/50 border-b border-white/20 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">One-time Discount</span>
                <div class="flex items-center gap-2">
                    <input type="number" id="shop-discount" placeholder="0" min="0" max="100" class="glass-input w-20 rounded-lg px-2 py-1 text-center text-sm font-bold text-slate-700 focus:bg-white transition-colors">
                    <span class="text-sm font-bold text-slate-400">% off</span>
                </div>
            </div>
            
            <input type="hidden" id="shop-child-id">
            
            <div class="p-6 overflow-y-auto" id="shop-items-grid">
                <!-- Items populated by JS -->
            </div>
        </div>
    </div>

    <!-- Manual Adjust Modal -->
    <div id="modal-adjust" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-sm mx-6 p-8 shadow-2xl">
            <h3 class="text-lg font-medium text-slate-800 mb-6 text-center">Manual Adjustment</h3>
            <input type="hidden" id="adjust-child-id">
            
            <div class="flex items-center justify-center gap-4 mb-4">
                <button onclick="adjustValue(-1)" class="w-10 h-10 rounded-full glass-btn flex items-center justify-center flex-shrink-0"><i data-lucide="minus" class="w-4 h-4"></i></button>
                
                <!-- Input Field -->
                <input type="number" id="adjust-input" value="0" class="text-4xl font-light text-slate-700 w-32 text-center bg-transparent focus:outline-none border-b-2 border-transparent focus:border-slate-300 transition-all placeholder-slate-300">
                
                <button onclick="adjustValue(1)" class="w-10 h-10 rounded-full glass-btn flex items-center justify-center flex-shrink-0"><i data-lucide="plus" class="w-4 h-4"></i></button>
            </div>

            <!-- Quick Add Buttons -->
            <div class="flex flex-col gap-2 mb-6">
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="adjustValue(5)" class="glass-btn py-2 rounded-lg text-xs font-bold text-green-600">+5</button>
                    <button onclick="adjustValue(10)" class="glass-btn py-2 rounded-lg text-xs font-bold text-green-600">+10</button>
                    <button onclick="adjustValue(20)" class="glass-btn py-2 rounded-lg text-xs font-bold text-green-600">+20</button>
                    <button onclick="adjustValue(50)" class="glass-btn py-2 rounded-lg text-xs font-bold text-green-600">+50</button>
                    <button onclick="adjustValue(100)" class="glass-btn py-2 rounded-lg text-xs font-bold text-green-600">+100</button>
                </div>
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="adjustValue(-5)" class="glass-btn py-2 rounded-lg text-xs font-bold text-red-500">-5</button>
                    <button onclick="adjustValue(-10)" class="glass-btn py-2 rounded-lg text-xs font-bold text-red-500">-10</button>
                    <button onclick="adjustValue(-20)" class="glass-btn py-2 rounded-lg text-xs font-bold text-red-500">-20</button>
                    <button onclick="adjustValue(-50)" class="glass-btn py-2 rounded-lg text-xs font-bold text-red-500">-50</button>
                    <button onclick="adjustValue(-100)" class="glass-btn py-2 rounded-lg text-xs font-bold text-red-500">-100</button>
                </div>
            </div>

            <!-- Reason Input -->
             <div class="mb-6">
                 <input type="text" id="adjust-reason" placeholder="Reason (e.g. Chores, Bad Grades)" class="glass-input w-full rounded-xl px-4 py-2 text-sm text-center">
             </div>
            
            <div class="flex gap-4">
                <button onclick="closeModal('modal-adjust')" class="flex-1 py-3 glass-btn rounded-xl font-medium">Cancel</button>
                <button onclick="confirmAdjust()" class="flex-1 py-3 glass-btn rounded-xl font-medium text-slate-800">Update</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="modal-history" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-lg mx-6 p-0 shadow-2xl overflow-hidden flex flex-col max-h-[70vh]">
            <div class="p-6 border-b border-white/30 flex justify-between items-center">
                <h3 class="text-lg font-medium text-slate-800">History Log</h3>
                <button onclick="closeModal('modal-history')" class="glass-btn p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div id="history-list" class="p-6 overflow-y-auto space-y-3">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>


    <!-- Store Manager Modal -->
    <div id="modal-store-manager" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-lg mx-6 p-8 shadow-2xl max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-medium text-slate-800">Store Manager</h3>
                <button onclick="closeModal('modal-store-manager')" class="glass-btn p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <div class="glass-panel p-5 rounded-2xl mb-8">
                <h4 class="font-medium text-xs text-slate-500 uppercase tracking-widest mb-4">Create Item</h4>
                <div class="space-y-3">
                    <input type="text" id="new-item-name" placeholder="Item Name" class="glass-input w-full rounded-xl px-4 py-2 text-sm">
                    <div class="flex gap-3">
                        <input type="number" id="new-item-cost" placeholder="Cost" class="glass-input w-2/3 rounded-xl px-4 py-2 text-sm">
                        <input type="number" id="new-item-duration" placeholder="Mins (0=None)" class="glass-input w-1/3 rounded-xl px-4 py-2 text-sm">
                    </div>
                    <select id="new-item-icon" class="glass-input w-full rounded-xl px-4 py-2 text-sm appearance-none">
                        <option value="gift">Gift</option>
                        <option value="tv">TV</option>
                        <option value="gamepad-2">Game</option>
                        <option value="ice-cream">Treat</option>
                        <option value="ticket">Ticket</option>
                        <option value="clock">Time</option>
                        <option value="bike">Bike</option>
                        <option value="book-open">Book</option>
                    </select>
                    <button onclick="addStoreItem()" class="w-full py-2 glass-btn rounded-xl text-sm font-medium mt-2">Add Item</button>
                </div>
            </div>

            <h4 class="font-medium text-xs text-slate-500 uppercase tracking-widest mb-4">Inventory</h4>
            <div id="manager-items-list" class="space-y-3">
                <!-- List populated by JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-200/20 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-panel rounded-3xl w-full max-w-sm mx-6 p-8 shadow-2xl text-center">
            <h3 class="text-lg font-medium text-slate-800 mb-8">Settings</h3>

            <div class="mb-6 text-left">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wide block mb-2">Hourly Payment Rate</label>
                <div class="flex gap-2">
                    <input type="number" id="setting-rate" class="glass-input w-full rounded-xl px-4 py-2" value="10">
                    <button onclick="updateRate()" class="glass-btn px-4 rounded-xl text-sm">Save</button>
                </div>
            </div>
            
            <button onclick="resetAllData()" class="w-full py-3 glass-btn rounded-xl text-red-500 hover:text-red-600 font-medium flex items-center justify-center gap-2 mb-4">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Reset All Data
            </button>
            
            <button onclick="closeModal('modal-settings')" class="w-full py-3 glass-btn rounded-xl font-medium text-slate-600">
                Close
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-full shadow-xl opacity-0 transition-all duration-300 pointer-events-none z-[60] flex items-center gap-3">
        <i data-lucide="info" class="w-4 h-4 text-slate-600"></i>
        <span id="toast-message" class="text-sm font-medium text-slate-700">Notification</span>
    </div>

    <script>
        // --- Discord Config ---
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1456438083791753350/X2bMYg1b-TE-vkaEUti7UPgEH8ahuWsrHLCUJR6iVJtVPhtdGX-w4EZ5iizl1EEN_rtI";

        // --- Auth State ---
        let currentUser = null; 

        // --- Data State ---
        const APP_KEY = 'baby_balance_local';
        let state = {
            children: [],
            items: [],
            logs: [], 
            hourlyRate: 10,
            lastSaved: Date.now()
        };

        // --- Initialization ---
        function init() {
            loadData();
            
            // Migration & Defaults
            if (!state.items) state.items = [];
            if (!state.children) state.children = [];
            if (!state.logs) state.logs = [];
            if (!state.hourlyRate) state.hourlyRate = 10;
            
            // Ensure children structure
            state.children.forEach(c => {
                if(typeof c.isPaused === 'undefined') c.isPaused = false;
                if(!c.cart) c.cart = []; 
                if(!c.activities) c.activities = [];
            });
            
            // Ensure items have duration
            state.items.forEach(i => {
                if(!i.duration) i.duration = 0;
            });

            document.getElementById('setting-rate').value = state.hourlyRate;
            
            // Just ensure initial timing calculation happened
            // gameLoop will handle continuous time deltas
            
            render(); 
            lucide.createIcons();
            
            // Start Loop
            setInterval(gameLoop, 1000); // UI update rate
        }

        // --- Logging & Undo ---
        function addLog(childName, action, details, undoData = null) {
            const entry = {
                id: crypto.randomUUID(),
                date: Date.now(),
                child: childName,
                action: action,
                details: details,
                user: currentUser ? currentUser.name : 'System',
                undoData: undoData
            };
            state.logs.unshift(entry); // Add to top
            // Keep log size managed
            if (state.logs.length > 50) state.logs.pop(); 
            
            // Send to Discord as well
            logToDiscord(`${action} - ${childName}: ${details} (by ${entry.user})`);
        }

        function undoAction(logId) {
            const logIndex = state.logs.findIndex(l => l.id === logId);
            if (logIndex === -1) return;
            const log = state.logs[logIndex];
            
            if (!log.undoData) return;
            
            const child = state.children.find(c => c.id === log.undoData.childId);
            if (!child) {
                showToast("Cannot undo: Child not found.");
                return;
            }

            if(confirm(`Undo "${log.action}"?`)) {
                // Perform Reverse Action
                if (log.undoData.type === 'adjustment') {
                    // Reverse the amount
                    child.balance -= log.undoData.amount;
                } else if (log.undoData.type === 'purchase') {
                    // Refund
                    child.balance += log.undoData.amount;
                }

                // Remove log entry
                state.logs.splice(logIndex, 1);
                saveData();
                render();
                
                // Refresh modal if open
                const historyModal = document.getElementById('modal-history');
                if(!historyModal.classList.contains('opacity-0')) {
                    openHistory(child.id);
                }
                
                showToast("Action Undone.");
                logToDiscord(`↩️ **Undo:** Reverted "${log.action}" for ${child.name} by ${currentUser.name}.`);
            }
        }

        function deleteLog(logId, childId) {
            if(confirm("Delete this log entry?")) {
                state.logs = state.logs.filter(l => l.id !== logId);
                saveData();
                openHistory(childId); // Refresh modal
            }
        }

        function logToDiscord(message) {
            if (!message) return;
            fetch(DISCORD_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: message })
            }).catch(err => console.error("Discord Log Error:", err));
        }

        // --- Local Storage Logic ---
        function loadData() {
            try {
                const stored = localStorage.getItem(APP_KEY);
                if (stored) {
                    state = JSON.parse(stored);
                }
            } catch (e) { console.error("Failed to load data", e); }
        }

        function saveData() {
            state.lastSaved = Date.now();
            localStorage.setItem(APP_KEY, JSON.stringify(state));
        }

        // --- Auth Logic ---
        function checkLoginName() {
            const name = document.getElementById('login-name').value.trim().toLowerCase();
            const pinContainer = document.getElementById('pin-container');
            if (name === 'elijah') {
                pinContainer.classList.remove('hidden-force');
                pinContainer.classList.remove('h-0', 'opacity-0');
                pinContainer.classList.add('h-20', 'opacity-100');
            } else {
                pinContainer.classList.add('hidden-force');
                document.getElementById('login-pin').value = '';
            }
        }

        function attemptLogin() {
            const nameInput = document.getElementById('login-name').value.trim();
            const nameLower = nameInput.toLowerCase();
            const pin = document.getElementById('login-pin').value;
            if (!nameInput) return;

            let role = 'viewer';
            if (nameLower === 'elijah') {
                if (pin === '1912') role = 'admin';
                else { alert("Incorrect PIN for Elijah."); return; }
            } else if (nameLower === 'lacey' || nameLower === 'chris') {
                role = 'adjuster';
            }

            currentUser = { name: nameInput, role: role };
            document.getElementById('current-user-badge').innerText = `${currentUser.name} • ${role === 'admin' ? 'Admin' : (role === 'adjuster' ? 'Parent' : 'Viewer')}`;
            document.getElementById('modal-login').classList.add('opacity-0', 'pointer-events-none');
            render();
            showToast(`Welcome, ${currentUser.name}!`);
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-name').value = '';
            document.getElementById('login-pin').value = '';
            document.getElementById('pin-container').classList.add('hidden-force');
            document.getElementById('modal-login').classList.remove('opacity-0', 'pointer-events-none');
        }

        // --- Core Logic (Delta Time) ---
        // We use state.lastSaved as the "last tick" time.
        // This unifies "app open loop" and "app closed time travel" into one logic.
        // The game loop simply calculates (Now - LastSaved) and applies it.
        // This handles background tabs automatically because (Now - LastSaved) will just be a bigger number.

        function gameLoop() {
            const now = Date.now();
            // Calculate time passed since last update (or last save if closed)
            // Ensure we don't process negative time (clock drift protection)
            let deltaTime = Math.max(0, now - state.lastSaved); 
            
            // Only update if time has actually passed (prevents unnecessary calcs)
            if (deltaTime > 0) {
                let needsRender = false;

                state.children.forEach(child => {
                    // 1. Process Activities
                    if (child.activities && child.activities.length > 0) {
                        child.activities.forEach(act => {
                            if (!act.isPaused) {
                                act.timeLeft = Math.max(0, act.timeLeft - deltaTime);
                            }
                        });
                        
                        // Check for completion
                        const activeCount = child.activities.length;
                        child.activities = child.activities.filter(a => a.timeLeft > 0);
                        if (child.activities.length !== activeCount) {
                            showToast("Activity Finished!");
                            needsRender = true;
                        }
                        
                        // Show visible countdown updates
                        if (activeCount > 0) needsRender = true;
                    }

                    // 2. Process Bad Mode & Earning
                    if (!child.isPaused) {
                        if (child.status === 'bad' && child.badUntil) {
                            if (now >= child.badUntil) {
                                child.status = 'good';
                                child.badUntil = null;
                                showToast(`${child.name} is back in Good Mode!`);
                                addLog(child.name, 'Status', 'Returned to Good Mode');
                                needsRender = true;
                            }
                        } else if (child.status === 'good') {
                            // Accumulate time
                            child.earningProgress += deltaTime;
                            
                            const ONE_HOUR_MS = 3600000;
                            // Check for payout(s) - handle multiple hours if tab closed for long time
                            while (child.earningProgress >= ONE_HOUR_MS) {
                                child.balance += state.hourlyRate;
                                child.earningProgress -= ONE_HOUR_MS;
                                showToast(`${child.name} earned ${state.hourlyRate} Bucks!`);
                                needsRender = true;
                            }
                        }
                    }
                });

                // Commit time update
                state.lastSaved = now;
                saveData(); 
                
                updateTimers(); // Visual update for sub-second/second changes
                if (needsRender) render();
            }
        }

        // --- Activity Logic ---
        function toggleActivity(childId, actId) {
            const child = state.children.find(c => c.id === childId);
            const act = child.activities.find(a => a.id === actId);
            if (act) {
                act.isPaused = !act.isPaused;
                saveData();
                render(); // Re-render to update icon
            }
        }

        function endActivity(childId, actId) {
            const child = state.children.find(c => c.id === childId);
            if (confirm("End/Delete this activity?")) {
                child.activities = child.activities.filter(a => a.id !== actId);
                saveData();
                render();
            }
        }

        // --- Render Helpers ---
        function updateTimers() {
            const now = Date.now();
            const ONE_HOUR_MS = 3600000;
            
            state.children.forEach(child => {
                // Bad Timer
                if (child.status === 'bad') {
                    const el = document.getElementById(`timer-${child.id}`);
                    if (el) {
                        const remaining = Math.max(0, Math.ceil((child.badUntil - now) / 1000));
                        const m = Math.floor(remaining / 60);
                        const s = remaining % 60;
                        el.innerText = `${m}m ${s}s`;
                    }
                } 
                
                // Next Payment Timer
                const payTimerEl = document.getElementById(`pay-timer-${child.id}`);
                if (payTimerEl) {
                    if(child.status === 'bad' || child.isPaused) {
                         payTimerEl.innerText = "Paused";
                         payTimerEl.className = "text-xs font-mono font-bold text-slate-400";
                    } else {
                        const msLeft = ONE_HOUR_MS - child.earningProgress;
                        const secLeft = Math.ceil(msLeft / 1000);
                        const m = Math.floor(secLeft / 60);
                        const s = secLeft % 60;
                        payTimerEl.innerText = `${m}m ${s}s`;
                        payTimerEl.className = "text-xs font-mono font-bold text-green-600";
                    }
                }

                // Progress Bar (Visual)
                const bar = document.getElementById(`progress-${child.id}`);
                if (bar) {
                    const pct = Math.min(100, (child.earningProgress / ONE_HOUR_MS) * 100);
                    bar.style.width = `${pct}%`;
                }
            });
        }

        function isAdmin() { return currentUser && currentUser.role === 'admin'; }
        function canAdjust() { return currentUser && (currentUser.role === 'admin' || currentUser.role === 'adjuster'); }

        function render() {
            if (!currentUser) return;

            const container = document.getElementById('children-container');
            const totalBalanceEl = document.getElementById('total-balance');
            const totalItemsEl = document.getElementById('total-items');
            const totalItemsRoEl = document.getElementById('total-items-ro');

            // Visibility
            const adminOnlyElements = ['btn-settings', 'btn-add-child', 'card-store-manager'];
            adminOnlyElements.forEach(id => {
                const el = document.getElementById(id);
                if (isAdmin()) el.classList.remove('hidden-force');
                else el.classList.add('hidden-force');
            });
            const roCard = document.getElementById('card-store-readonly');
            if (!isAdmin()) roCard.classList.remove('hidden-force');
            else roCard.classList.add('hidden-force');

            // Totals
            const total = state.children.reduce((acc, c) => acc + c.balance, 0);
            totalBalanceEl.innerText = total;
            totalItemsEl.innerText = state.items.length;
            totalItemsRoEl.innerText = state.items.length;

            if (state.children.length === 0) {
                container.innerHTML = `<div class="col-span-full py-16 text-center glass-panel rounded-2xl fade-in"><p class="text-slate-500 text-sm">No children added yet.</p></div>`;
            } else {
                container.innerHTML = state.children.map(child => {
                    const isBad = child.status === 'bad';
                    const isPaused = child.isPaused;

                    const showAdjust = canAdjust() ? '' : 'hidden-force';
                    const showLogBad = canAdjust() ? '' : 'hidden-force';
                    const showSpend = isAdmin() ? '' : 'hidden-force';
                    const showDelete = isAdmin() ? 'opacity-0 hover:opacity-100' : 'hidden-force';

                    // --- Activities List HTML ---
                    let activitiesHtml = '';
                    if (child.activities && child.activities.length > 0) {
                        activitiesHtml = `<div class="mt-4 space-y-2 border-t border-slate-100 pt-3">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Active Now</p>`;
                        
                        activitiesHtml += child.activities.map(act => {
                            // Format Time
                            const totalSecs = Math.ceil(act.timeLeft / 1000);
                            const h = Math.floor(totalSecs / 3600);
                            const m = Math.floor((totalSecs % 3600) / 60);
                            const s = totalSecs % 60;
                            const timeStr = `${h > 0 ? h+'h ' : ''}${m}m ${s}s`;

                            return `
                            <div class="glass-panel p-2 rounded-lg flex items-center justify-between bg-blue-50/50">
                                <div>
                                    <span class="text-xs font-bold text-slate-700 block">${act.name}</span>
                                    <span class="text-xs font-mono text-blue-600 ${act.isPaused ? 'opacity-50' : ''}">${timeStr}</span>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="toggleActivity('${child.id}', '${act.id}')" class="glass-btn p-1.5 rounded-md text-slate-500 hover:bg-white">
                                        <i data-lucide="${act.isPaused ? 'play' : 'pause'}" class="w-3 h-3"></i>
                                    </button>
                                    <button onclick="endActivity('${child.id}', '${act.id}')" class="glass-btn p-1.5 rounded-md text-red-400 hover:bg-white">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            `;
                        }).join('');
                        
                        activitiesHtml += `</div>`;
                    }

                    return `
                    <div class="glass-panel rounded-3xl p-6 relative flex flex-col justify-between overflow-hidden transition-all hover:bg-white/40 ${isBad ? 'glass-bad-active' : ''} fade-in">
                        
                        ${(!isBad && !isPaused) ? `<div class="absolute top-0 left-0 h-[2px] w-full bg-white/20"><div id="progress-${child.id}" class="h-full bg-green-400/50 transition-all duration-1000" style="width:0%"></div></div>` : ''}

                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-xl font-medium text-slate-800 tracking-tight flex items-center gap-2">
                                    ${child.name}
                                    <button onclick="openHistory('${child.id}')" class="text-slate-300 hover:text-slate-500"><i data-lucide="history" class="w-4 h-4"></i></button>
                                </h3>
                                
                                <div class="mt-1 flex items-center gap-2">
                                    ${isBad 
                                        ? `<span class="inline-flex items-center gap-1 text-[10px] font-bold uppercase tracking-wider text-red-500"><i data-lucide="lock" class="w-3 h-3"></i> Bad Mode</span>`
                                        : (isPaused 
                                            ? `<span class="inline-flex items-center gap-1 text-[10px] font-bold uppercase tracking-wider text-orange-400"><i data-lucide="pause-circle" class="w-3 h-3"></i> Paused</span>` 
                                            : `<span class="inline-flex items-center gap-1 text-[10px] font-bold uppercase tracking-wider text-green-600"><i data-lucide="check" class="w-3 h-3"></i> Earning</span>`
                                        )
                                    }
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block text-4xl font-light ${isBad ? 'text-slate-400' : 'text-slate-800'}">${child.balance}</span>
                                <div class="flex items-center justify-end gap-1 mt-1">
                                    <i data-lucide="timer" class="w-3 h-3 text-slate-400"></i>
                                    <span id="pay-timer-${child.id}" class="text-xs font-mono font-bold text-slate-400">...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bad Mode Controls -->
                        ${isBad ? `
                            <div class="glass-panel rounded-xl p-3 mb-4 text-center border-red-200/30">
                                <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-1">Time Out Remaining</p>
                                <p id="timer-${child.id}" class="text-lg font-mono text-red-500/80 font-medium">...</p>
                                <div class="flex justify-center gap-2 mt-2 ${canAdjust() ? '' : 'hidden-force'}">
                                    <button onclick="extendBadMode('${child.id}')" class="text-[10px] bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">+10m</button>
                                    <button onclick="endBadMode('${child.id}')" class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded hover:bg-slate-200">Clear</button>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Activities List -->
                        ${activitiesHtml}

                        <!-- Action Grid -->
                        <div class="grid grid-cols-4 gap-2 mt-auto pt-4">
                            <button onclick="openAdjustModal('${child.id}')" class="${showAdjust} glass-btn flex flex-col items-center justify-center py-3 rounded-xl col-span-1">
                                <i data-lucide="sliders-horizontal" class="w-4 h-4 mb-1 opacity-70"></i>
                                <span class="text-[10px] font-semibold uppercase">Adj</span>
                            </button>
                            
                            <!-- Toggle Pause (Only if not bad) -->
                            <button onclick="togglePause('${child.id}')" ${isBad ? 'disabled' : ''} class="${showAdjust} glass-btn flex flex-col items-center justify-center py-3 rounded-xl col-span-1 ${isPaused ? 'bg-orange-50 border-orange-200 text-orange-500' : ''}">
                                <i data-lucide="${isPaused ? 'play' : 'pause'}" class="w-4 h-4 mb-1 opacity-70"></i>
                                <span class="text-[10px] font-semibold uppercase">${isPaused ? 'Resume' : 'Pause'}</span>
                            </button>

                            <button onclick="openBadModal('${child.id}')" ${isBad ? 'disabled' : ''} class="${showLogBad} glass-btn flex flex-col items-center justify-center py-3 rounded-xl col-span-1 ${isBad ? '' : 'hover:text-red-500'}">
                                <i data-lucide="frown" class="w-4 h-4 mb-1 opacity-70"></i>
                                <span class="text-[10px] font-semibold uppercase">Bad</span>
                            </button>

                            <button onclick="openShopModal('${child.id}')" ${isBad ? 'disabled' : ''} class="${showSpend} glass-btn flex flex-col items-center justify-center py-3 rounded-xl col-span-1 ${isBad ? '' : 'hover:text-blue-500'}">
                                <i data-lucide="shopping-bag" class="w-4 h-4 mb-1 opacity-70"></i>
                                <span class="text-[10px] font-semibold uppercase">Shop</span>
                            </button>
                        </div>
                        
                        <button onclick="deleteChild('${child.id}')" class="absolute top-4 right-4 p-2 text-slate-300 hover:text-red-400 transition-colors ${showDelete}">
                            <i data-lucide="trash" class="w-4 h-4"></i>
                        </button>
                    </div>
                    `;
                }).join('');
            }

            renderStorePreview();
            lucide.createIcons();
        }

        function renderStorePreview() {
            const storePreview = document.getElementById('store-preview-container');
            if(state.items.length === 0) {
                storePreview.innerHTML = '<p class="text-slate-400 font-light text-sm col-span-3 text-center py-4">Store is empty.</p>';
            } else {
                storePreview.innerHTML = state.items.map(item => `
                    <div class="glass-panel p-4 rounded-xl flex items-center gap-3 hover:bg-white/40 transition-colors">
                        <i data-lucide="${item.icon}" class="w-5 h-5 text-slate-500"></i>
                        <div class="overflow-hidden">
                            <h4 class="font-medium text-slate-700 text-sm truncate">${item.name}</h4>
                            <span class="text-xs font-medium text-slate-400">${item.cost} Bucks</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // --- History Logic ---
        function openHistory(childId) {
            const child = state.children.find(c => c.id === childId);
            if(!child) return;
            
            const list = document.getElementById('history-list');
            // Filter logs for this child or global events if needed
            const childLogs = state.logs.filter(l => l.child === child.name);
            
            if(childLogs.length === 0) {
                list.innerHTML = `<p class="text-center text-slate-400 text-sm">No history yet.</p>`;
            } else {
                list.innerHTML = childLogs.map(log => {
                    const date = new Date(log.date);
                    const canUndo = log.undoData && canAdjust(); // Only adjusters can undo
                    
                    return `
                    <div class="glass-panel p-3 rounded-xl mb-2 relative group">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-bold text-slate-400 uppercase">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">${log.user}</span>
                        </div>
                        <p class="font-medium text-slate-700 mt-1">${log.action}</p>
                        <p class="text-sm text-slate-500">${log.details}</p>
                        
                        <div class="flex gap-2 mt-2 border-t border-slate-100 pt-2 opacity-60 group-hover:opacity-100 transition-opacity">
                            ${canUndo ? `
                                <button onclick="undoAction('${log.id}')" class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded hover:bg-orange-200 font-bold flex items-center gap-1">
                                    <i data-lucide="undo-2" class="w-3 h-3"></i> Undo
                                </button>
                            ` : ''}
                            <button onclick="deleteLog('${log.id}', '${childId}')" class="text-xs bg-red-50 text-red-400 px-2 py-1 rounded hover:bg-red-100">Delete</button>
                        </div>
                    </div>
                    `;
                }).join('');
                lucide.createIcons(); // Refresh icons in modal
            }
            
            openModal('modal-history');
        }

        // --- Store Actions ---
        function renderStoreManagerList() {
            const list = document.getElementById('manager-items-list');
            list.innerHTML = state.items.map(item => `
                <div class="flex justify-between items-center glass-panel p-3 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i data-lucide="${item.icon}" class="w-4 h-4 text-slate-400"></i>
                        <div>
                            <p class="font-medium text-slate-700 text-sm">${item.name}</p>
                            <p class="text-xs text-slate-400">${item.cost} Bucks ${item.duration > 0 ? `• ${item.duration}m` : ''}</p>
                        </div>
                    </div>
                    <button onclick="deleteStoreItem('${item.id}')" class="text-slate-300 hover:text-red-400 p-2 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderShopGrid(childId) {
            const child = state.children.find(c => c.id === childId);
            const grid = document.getElementById('shop-items-grid');
            const nameSpan = document.getElementById('shop-child-name');
            nameSpan.innerText = `${child.name} (${child.balance})`;
            document.getElementById('shop-child-id').value = childId;

            let html = '';

            // --- 1. Render Saved/Cart Section ---
            if (child.cart && child.cart.length > 0) {
                html += `<div class="mb-6">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                        <i data-lucide="clock" class="w-3 h-3"></i> Saved for Later
                    </h4>
                    <div class="space-y-2">`;
                
                html += child.cart.map((cartItem, index) => {
                    const originalItem = state.items.find(i => i.id === cartItem.itemId);
                    if(!originalItem) return ''; // Item might have been deleted from store
                    
                    const finalCost = cartItem.savedCost;
                    const canAfford = child.balance >= finalCost;
                    
                    return `
                    <div class="glass-panel p-3 rounded-xl flex justify-between items-center bg-yellow-50/50 border-yellow-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-slate-400">
                                <i data-lucide="${originalItem.icon}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm">${originalItem.name}</p>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold ${canAfford ? 'text-green-600' : 'text-red-400'}">${finalCost} Bucks</span>
                                    ${cartItem.discount > 0 ? `<span class="text-[10px] bg-green-100 text-green-600 px-1.5 rounded-md">-${cartItem.discount}% Saved</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="buyFromCart('${childId}', ${index})" ${!canAfford ? 'disabled' : ''} class="glass-btn px-3 py-1.5 rounded-lg text-xs font-bold ${canAfford ? 'text-green-600 hover:bg-green-50' : 'opacity-50'}">
                                Buy
                            </button>
                            <button onclick="removeFromCart('${childId}', ${index})" class="glass-btn p-1.5 rounded-lg text-slate-400 hover:text-red-500">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
                
                html += `</div></div> <div class="h-px bg-slate-200 w-full mb-6"></div>`;
            }

            // --- 2. Render Main Store Grid ---
            if(state.items.length === 0) {
                html += '<p class="text-slate-400 font-light text-sm col-span-3 text-center py-4">Store is empty.</p>';
            } else {
                html += `<div class="grid grid-cols-2 gap-3">` + state.items.map(item => {
                    const canAfford = child.balance >= item.cost;
                    return `
                    <div class="relative p-4 rounded-2xl glass-panel group hover:bg-white/40 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                             <div class="w-10 h-10 rounded-full ${canAfford ? 'bg-blue-50 text-blue-500' : 'bg-slate-100 text-slate-400'} flex items-center justify-center">
                                <i data-lucide="${item.icon}"></i>
                            </div>
                            <!-- Save Button -->
                            <button onclick="saveForLater('${item.id}', '${childId}')" class="p-2 -mr-2 -mt-2 text-slate-300 hover:text-yellow-500 transition-colors" title="Save for Later">
                                <i data-lucide="bookmark-plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                       
                        <h4 class="font-medium text-slate-800 text-sm leading-tight mb-1">${item.name}</h4>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold ${canAfford ? 'text-green-600' : 'text-slate-400'}">${item.cost} Bucks</span>
                            ${item.duration > 0 ? `<span class="text-[10px] text-slate-400 font-mono"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${item.duration}m</span>` : ''}
                        </div>
                        
                        <button onclick="buyItem('${item.id}', '${childId}')" ${!canAfford ? 'disabled' : ''} class="w-full mt-3 glass-btn py-2 rounded-xl text-xs font-bold ${canAfford ? 'text-blue-600' : 'opacity-50'}">
                            Buy Now
                        </button>
                    </div>
                    `;
                }).join('') + `</div>`;
            }

            grid.innerHTML = html;
            lucide.createIcons();
        }

        // --- Cart / Saved Logic ---

        function saveForLater(itemId, childId) {
            const child = state.children.find(c => c.id === childId);
            const item = state.items.find(i => i.id === itemId);
            
            // Check for discount input
            const discountInput = document.getElementById('shop-discount');
            let discountPercent = parseInt(discountInput.value);
            if (isNaN(discountPercent) || discountPercent < 0) discountPercent = 0;
            if (discountPercent > 100) discountPercent = 100;

            // Calculate cost to freeze
            let savedCost = item.cost;
            if (discountPercent > 0) {
                savedCost = Math.round(item.cost * ((100 - discountPercent) / 100));
            }

            // Add to cart
            child.cart.push({
                itemId: itemId,
                discount: discountPercent,
                savedCost: savedCost,
                date: Date.now()
            });
            
            saveData();
            showToast("Saved for later!");
            addLog(child.name, 'Saved', `Saved ${item.name} for later (Cost: ${savedCost})`);
            renderShopGrid(childId); // Re-render to show in Saved section
        }

        function removeFromCart(childId, index) {
            const child = state.children.find(c => c.id === childId);
            if(child && child.cart[index]) {
                child.cart.splice(index, 1);
                saveData();
                renderShopGrid(childId);
            }
        }

        function buyFromCart(childId, index) {
            const child = state.children.find(c => c.id === childId);
            const cartItem = child.cart[index];
            const originalItem = state.items.find(i => i.id === cartItem.itemId);
            
            if(!child || !cartItem || !originalItem) return;

            if (child.balance < cartItem.savedCost) {
                alert(`Not enough Bucks! Need ${cartItem.savedCost}.`);
                return;
            }

            if(confirm(`Buy saved item: ${originalItem.name} for ${cartItem.savedCost} Bucks?`)) {
                child.balance -= cartItem.savedCost;
                // Add to activities if applicable
                if (originalItem.duration > 0) {
                    child.activities.push({
                        id: crypto.randomUUID(),
                        name: originalItem.name,
                        timeLeft: originalItem.duration * 60000,
                        isPaused: false
                    });
                }

                // Remove from cart
                child.cart.splice(index, 1);
                
                saveData();
                showToast(`${originalItem.name} purchased!`);
                addLog(child.name, 'Purchase (Saved)', `Bought ${originalItem.name} for ${cartItem.savedCost}`, { type: 'purchase', amount: cartItem.savedCost, childId: childId });
                
                renderShopGrid(childId);
                render(); // Update background stats
            }
        }

        // --- Standard Buy Logic (Updated to use item card button) ---
        function buyItem(itemId, childId) {
            const child = state.children.find(c => c.id === childId);
            const item = state.items.find(i => i.id === itemId);
            
            // Calculate Discount
            const discountInput = document.getElementById('shop-discount');
            let discountPercent = parseInt(discountInput.value);
            if (isNaN(discountPercent) || discountPercent < 0) discountPercent = 0;
            if (discountPercent > 100) discountPercent = 100;

            let finalCost = item.cost;
            if (discountPercent > 0) {
                finalCost = Math.round(item.cost * ((100 - discountPercent) / 100));
            }

            if (child && item) {
                if (child.balance < finalCost) {
                    alert(`Not enough Bucks! Need ${finalCost}.`);
                    return;
                }

                let confirmMsg = `Buy ${item.name} for ${finalCost} Bucks?`;
                if (discountPercent > 0) {
                    confirmMsg += `\n(Includes ${discountPercent}% discount off ${item.cost})`;
                }
                if (item.duration > 0) {
                    confirmMsg += `\nThis starts a ${item.duration}m activity timer.`;
                }

                if(confirm(confirmMsg)) {
                    child.balance -= finalCost; 
                    
                    // Start Activity
                    if (item.duration > 0) {
                        child.activities.push({
                            id: crypto.randomUUID(),
                            name: item.name,
                            timeLeft: item.duration * 60000,
                            isPaused: false
                        });
                    }

                    saveData(); 
                    showToast(`${item.name} purchased!`);
                    
                    let logDetails = `Bought ${item.name} for ${finalCost}`;
                    if (discountPercent > 0) logDetails += ` (${discountPercent}% off ${item.cost})`;
                    
                    // Add Undo Data
                    addLog(child.name, 'Purchase', logDetails, { type: 'purchase', amount: finalCost, childId: childId });
                    
                    renderShopGrid(childId); // Update balance in modal header
                    render(); // Update main UI
                }
            }
        }

        let selectedBadDuration = 15;
        function setBadTime(mins) {
            selectedBadDuration = mins;
            document.querySelectorAll('.time-btn').forEach(btn => {
                if(btn.innerText.includes(mins)) btn.classList.add('bg-white/60', 'text-slate-800', 'border-white');
                else btn.classList.remove('bg-white/60', 'text-slate-800', 'border-white');
            });
        }

        function confirmBadAction() {
            const id = document.getElementById('bad-child-id').value;
            const child = state.children.find(c => c.id === id);
            if(child) {
                child.status = 'bad';
                child.badUntil = Date.now() + (selectedBadDuration * 60000);
                saveData(); 
                closeModal('modal-bad'); 
                showToast(`${child.name} paused.`);
                addLog(child.name, 'Bad Mode', `Set for ${selectedBadDuration}m`);
                render();
            }
        }

        function endBadMode(id) {
            if(confirm("End bad mode early?")) {
                const child = state.children.find(c => c.id === id);
                child.status = 'good'; child.badUntil = null; 
                saveData(); 
                addLog(child.name, 'Forgiven', 'Bad mode ended manually');
                render();
            }
        }
        
        function extendBadMode(id) {
            const child = state.children.find(c => c.id === id);
            if(child && child.status === 'bad') {
                child.badUntil += (10 * 60000); // Add 10 mins
                saveData();
                render();
                addLog(child.name, 'Extended', 'Added 10 minutes to Bad Mode');
                showToast("Added 10 mins.");
            }
        }

        let adjustAmount = 0;
        function openAdjustModal(id) {
            document.getElementById('adjust-child-id').value = id;
            document.getElementById('adjust-reason').value = ''; 
            document.getElementById('adjust-input').value = 0; // Reset input
            adjustAmount = 0; 
            // updateAdjustDisplay(); // No longer needed with input field
            openModal('modal-adjust');
        }

        function adjustValue(val) { 
            const input = document.getElementById('adjust-input');
            let current = parseInt(input.value) || 0;
            current += val;
            input.value = current;
            adjustAmount = current;
        }
        
        function confirmAdjust() {
            const id = document.getElementById('adjust-child-id').value;
            const reason = document.getElementById('adjust-reason').value.trim() || 'No reason provided';
            
            // Read from INPUT
            const finalAmount = parseInt(document.getElementById('adjust-input').value);
            
            const child = state.children.find(c => c.id === id);
            
            if(child && finalAmount !== 0) { 
                child.balance += finalAmount; 
                saveData(); 
                showToast(`Updated.`); 
                addLog(child.name, 'Adjustment', `${finalAmount > 0 ? '+' : ''}${finalAmount} (Reason: ${reason})`, { type: 'adjustment', amount: finalAmount, childId: child.id });
                render();
            }
            closeModal('modal-adjust');
        }
        
        function updateRate() {
            const rate = parseInt(document.getElementById('setting-rate').value);
            if(rate > 0) {
                state.hourlyRate = rate;
                saveData();
                showToast(`Rate set to ${rate}/hr`);
                addLog('System', 'Settings', `Hourly rate changed to ${rate}`);
            }
        }

        function resetAllData() {
            if(confirm("Are you sure? This deletes all children and history.")) {
                state = { children: [], items: [], logs: [], hourlyRate: 10, lastSaved: Date.now() };
                saveData();
                closeModal('modal-settings');
                showToast("All data reset.");
                logToDiscord(`⚠️ **RESET:** All family data was wiped by ${currentUser.name}.`);
                render();
            }
        }

        // --- UI Utils ---
        function openModal(id) {
            const el = document.getElementById(id);
            el.classList.remove('opacity-0', 'pointer-events-none');
            el.querySelector('div').classList.remove('scale-95');
            el.querySelector('div').classList.add('scale-100');
        }
        function closeModal(id) {
            const el = document.getElementById(id);
            el.classList.add('opacity-0', 'pointer-events-none');
            el.querySelector('div').classList.remove('scale-100');
            el.querySelector('div').classList.add('scale-95');
        }

        // Added missing function definition
        function openAddChildModal() { 
            openModal('modal-add-child'); 
            document.getElementById('new-child-name').focus(); 
        }

        function addChild() {
            const name = document.getElementById('new-child-name').value.trim();
            if (!name) return;
            state.children.push({ id: crypto.randomUUID(), name, balance: 0, status: 'good', isPaused: false, badUntil: null, earningProgress: 0 });
            saveData(); 
            document.getElementById('new-child-name').value = ''; 
            closeModal('modal-add-child'); 
            showToast(`${name} added!`);
            addLog(name, 'Added', 'New child created');
            render();
        }

        function deleteChild(id) {
            if(confirm("Remove this child?")) { 
                const child = state.children.find(c => c.id === id);
                addLog(child.name, 'Deleted', 'Child removed from system');
                state.children = state.children.filter(c => c.id !== id); 
                saveData(); 
                render();
            }
        }
        
        function togglePause(id) {
            const child = state.children.find(c => c.id === id);
            if(child) {
                child.isPaused = !child.isPaused;
                saveData();
                render();
                addLog(child.name, child.isPaused ? 'Paused' : 'Resumed', 'Manual earning toggle');
            }
        }

        function addStoreItem() {
            const name = document.getElementById('new-item-name').value;
            const cost = parseInt(document.getElementById('new-item-cost').value);
            const duration = parseInt(document.getElementById('new-item-duration').value) || 0;
            const icon = document.getElementById('new-item-icon').value;
            
            if(!name || isNaN(cost)) return;
            
            state.items.push({ id: crypto.randomUUID(), name, cost, duration, icon });
            saveData(); 
            renderStoreManagerList();
            render();
            
            document.getElementById('new-item-name').value = ''; 
            document.getElementById('new-item-cost').value = '';
            document.getElementById('new-item-duration').value = '';
        }

        function deleteStoreItem(id) {
            state.items = state.items.filter(i => i.id !== id); 
            saveData(); 
            renderStoreManagerList();
            render();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000);
        }

        // --- Window Exports ---
        // Explicitly attach all interactive functions to window to prevent ReferenceErrors
        Object.assign(window, {
            addChild,
            deleteChild,
            togglePause,
            addStoreItem,
            deleteStoreItem,
            buyItem,
            saveForLater,
            removeFromCart,
            buyFromCart,
            setBadTime,
            confirmBadAction,
            endBadMode,
            extendBadMode,
            openAdjustModal,
            adjustValue,
            confirmAdjust,
            updateRate,
            resetAllData,
            openModal,
            closeModal,
            openAddChildModal,
            openBadModal: function(id) { document.getElementById('bad-child-id').value = id; setBadTime(15); openModal('modal-bad'); },
            openShopModal: function(id) { renderShopGrid(id); document.getElementById('shop-discount').value = ''; openModal('modal-shop'); },
            openStoreManager: function() { renderStoreManagerList(); openModal('modal-store-manager'); },
            openSettings: function() { openModal('modal-settings'); },
            openHistory,
            undoAction,
            deleteLog,
            toggleActivity,
            endActivity,
            attemptLogin,
            checkLoginName,
            logout
        });

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
